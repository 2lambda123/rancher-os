#!/bin/bash
set -e

source $(dirname $0)/version

cd $(dirname $0)/..

export TAG
make build
make iso

if [ -n "$DOCKER_PASSWORD" ]; then
    docker login -u "$DOCKER_USERNAME" -p "${DOCKER_PASSWORD}"
    PUSH=true
fi

if [ "$PUSH" = "true" ]; then
    make push
    make push-framework
fi

if [ "$PUSH" = "true" ] && [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
    IMAGE_TARGETS="${IMAGE_TARGETS} all-amis"
fi

export GIT_COMMIT=${COMMIT}
if [ -n "${IMAGE_TARGETS}" ]; then
    make -j8 ${IMAGE_TARGETS}
fi

isoinfo -x /rootfs.squashfs -R -i build/output.iso > build/output.squashfs
isoinfo -x /boot/kernel.xz -R -i build/output.iso > build/output-kernel
isoinfo -x /boot/rootfs.xz -R -i build/output.iso > build/output-initrd

mkdir -p dist/artifacts
for i in build/output*; do
    mv -f $i dist/artifacts/rancheros-${TAG}${i##build/output}
    echo Built: dist/artifacts/rancheros-${TAG}${i##build/output}
done
